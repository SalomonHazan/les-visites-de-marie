{% extends "base.html" %}

{% block title %}{{ carnet.titre }} - Les Visites de Marie{% endblock %}

{% block content %}
    <div class="visite-detail">
        <div class="visite-header">
            <div class="visite-image-large">
                {% if carnet.image_url %}
                    {% if carnet.image_url.startswith('http') %}
                        <img src="{{ carnet.image_url }}" alt="{{ carnet.titre }}">
                    {% else %}
                        <img src="{{ url_for('static', filename=carnet.image_url) }}" alt="{{ carnet.titre }}">
                    {% endif %}
                {% else %}
                    <div class="no-image-large">📷</div>
                {% endif %}
            </div>
            <div class="visite-info">
                <h1>{{ carnet.titre }}</h1>
                <p class="visite-description-full">{{ carnet.description_complete }}</p>
                <div class="visite-stats">
                    <span class="stat">
                        <strong>{{ carnet.etapes|length }}</strong> étapes
                    </span>
                    <span class="stat">
                        <strong>{{ carnet.conseils|length }}</strong> conseils
                    </span>
                    <span class="stat">
                        Créé le {{ carnet.date_creation[:10] }}
                    </span>
                    <span class="stat">
                        Catégorie : 
                        {% if categorie == 'musees_expositions' %}🏛️ Musées & Expositions
                        {% elif categorie == 'theatre_spectacles' %}🎭 Théâtre & Spectacles
                        {% elif categorie == 'litterature' %}📚 Littérature
                        {% else %}{{ categorie }}{% endif %}
                    </span>
                </div>
            </div>
        </div>

        <div class="visite-etapes">
            <h2>Itinéraire du carnet</h2>
            {% for etape in carnet.etapes %}
                <div class="etape">
                    <div class="etape-numero">
                        <span class="numero">{{ loop.index }}</span>
                    </div>
                    <div class="etape-header">
                        <h3>{{ etape.titre }}</h3>
                        <span class="duree">{{ etape.duree }}</span>
                    </div>
                    <p>{{ etape.description }}</p>
                    {% if etape.adresse %}
                        <div class="etape-adresse">
                            <div class="etape-info">
                                <strong>📍 Adresse :</strong> {{ etape.adresse }}
                            </div>
                            <div class="etape-actions">
                                <a href="https://maps.google.com/?q={{ etape.adresse|urlencode }}" 
                                   target="_blank" class="btn btn-small btn-green">
                                    Voir sur Google Maps
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    {% if etape.metro %}
                        <div class="etape-metro">
                            <strong>🚇 Métro :</strong> {{ etape.metro }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        {% if carnet.conseils %}
            <div class="visite-conseils">
                <h2>Conseils pour ce carnet</h2>
                <ul class="conseils-list">
                    {% for conseil in carnet.conseils %}
                        <li>{{ conseil }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}

        {% if carnet.etapes %}
            <div class="visite-parcours-map">
                <h2>🗺️ Carte du parcours</h2>
                <div class="parcours-map">
                    <div id="map" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
            
            <script>
                // Méthode simple : utiliser OpenStreetMap (gratuit, sans clé API)
                function initMap() {
                    console.log('=== MÉTHODE SIMPLE : Carte OpenStreetMap ===');
                    
                    // Récupérer toutes les adresses des étapes
                    const adresses = [
                        {% for etape in carnet.etapes %}
                            {% if etape.adresse %}
                                "{{ etape.adresse|replace('"', '\\"')|replace("'", "\\'") }}",
                            {% endif %}
                        {% endfor %}
                    ];
                    
                    console.log('Adresses trouvées:', adresses.length);
                    
                    if (adresses.length === 0) {
                        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d; font-style: italic;">Aucune adresse disponible pour afficher le parcours</div>';
                        return;
                    }
                    
                    // Créer une carte OpenStreetMap avec Leaflet
                    const mapDiv = document.getElementById('map');
                    mapDiv.innerHTML = `
                        <div id="openstreetmap" style="width: 100%; height: 400px; border-radius: 10px;"></div>
                    `;
                    
                    // Charger Leaflet CSS et JS
                    const leafletCSS = document.createElement('link');
                    leafletCSS.rel = 'stylesheet';
                    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                    leafletCSS.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                    leafletCSS.crossOrigin = '';
                    document.head.appendChild(leafletCSS);
                    
                    const leafletJS = document.createElement('script');
                    leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    leafletJS.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                    leafletJS.crossOrigin = '';
                    
                    leafletJS.onload = function() {
                        // Initialiser la carte centrée sur Paris
                        const map = L.map('openstreetmap').setView([48.8566, 2.3522], 13);
                        
                        // Ajouter la couche OpenStreetMap
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '© OpenStreetMap contributors'
                        }).addTo(map);
                        
                        const markers = [];
                        const coordinates = [];
                        let processedCount = 0;
                        
                        // Fonction pour centrer la carte sur tous les marqueurs
                        function fitMapToMarkers() {
                            if (coordinates.length > 0) {
                                const bounds = L.latLngBounds(coordinates);
                                map.fitBounds(bounds, { padding: [20, 20] });
                                console.log('✅ Carte centrée sur tous les marqueurs');
                            }
                        }
                        
                        // Fonction pour dessiner une route entre deux points
                        function drawRoute(fromCoord, toCoord, index) {
                            const url = `https://router.project-osrm.org/route/v1/foot/${fromCoord.lng},${fromCoord.lat};${toCoord.lng},${toCoord.lat}?overview=full&geometries=geojson`;
                            fetch(url)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.routes && data.routes.length > 0) {
                                        const route = data.routes[0];
                                        const routeGeometry = route.geometry;
                                        const routeLine = L.geoJSON(routeGeometry, {
                                            style: {
                                                color: '#8B008B', // Rose fuchsia foncé
                                                weight: 4,
                                                opacity: 0.8
                                            }
                                        }).addTo(map);
                                        console.log(`✅ Itinéraire ${index} dessiné (${Math.round(route.distance)}m, ${Math.round(route.duration / 60)}min)`);
                                    }
                                })
                                .catch(error => {
                                    console.log(`Erreur calcul itinéraire ${index}:`, error);
                                    const straightLine = L.polyline([fromCoord, toCoord], {
                                        color: '#8B008B', // Rose fuchsia foncé
                                        weight: 3,
                                        opacity: 0.6,
                                        dashArray: '5, 5'
                                    }).addTo(map);
                                });
                        }
                        
                        // Traiter chaque adresse
                        adresses.forEach((adresse, index) => {
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresse + ', Paris, France')}&limit=1`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.length > 0) {
                                        const lat = parseFloat(data[0].lat);
                                        const lon = parseFloat(data[0].lon);
                                        const coord = L.latLng(lat, lon);
                                        
                                        // Créer un marqueur personnalisé
                                        const marker = L.marker(coord, {
                                            icon: L.divIcon({
                                                className: 'custom-marker',
                                                html: `<div style="background: #8e44ad; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${index + 1}</div>`,
                                                iconSize: [30, 30],
                                                iconAnchor: [15, 15]
                                            })
                                        }).addTo(map);
                                        
                                        // Ajouter une popup avec les informations
                                        const popupContent = `
                                            <div style="padding: 10px; max-width: 200px;">
                                                <h4 style="margin: 0 0 5px 0; color: #8e44ad;">Étape ${index + 1}</h4>
                                                <p style="margin: 0; font-size: 12px; color: #666;">${adresse}</p>
                                                <a href="https://maps.google.com/?q=${encodeURIComponent(adresse)}"
                                                   target="_blank"
                                                   style="color: #8e44ad; text-decoration: none; font-size: 11px;">
                                                   📍 Voir sur Google Maps
                                                </a>
                                            </div>
                                        `;
                                        marker.bindPopup(popupContent);
                                        
                                        markers.push(marker);
                                        coordinates.push(coord);
                                    }
                                    
                                    processedCount++;
                                    if (processedCount === adresses.length) {
                                        setTimeout(() => {
                                            fitMapToMarkers();
                                            // Dessiner les routes entre les étapes
                                            for (let i = 0; i < coordinates.length - 1; i++) {
                                                const fromCoord = coordinates[i];
                                                const toCoord = coordinates[i + 1];
                                                drawRoute(fromCoord, toCoord, i + 1);
                                            }
                                        }, 1000);
                                    }
                                })
                                .catch(error => {
                                    console.log('Erreur géocodage pour:', adresse, error);
                                    processedCount++;
                                    if (processedCount === adresses.length) {
                                        setTimeout(fitMapToMarkers, 1000);
                                    }
                                });
                        });
                        
                        console.log('✅ Carte OpenStreetMap créée avec succès !');
                    };
                    document.head.appendChild(leafletJS);
                }
                
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initMap);
                } else {
                    initMap();
                }
            </script>
        {% endif %}
        
        <div class="return-link">
            <a href="{{ url_for('menu_page', menu_id='cultures') }}" class="btn btn-secondary">
                ← Retour aux carnets de culture
            </a>
        </div>
    </div>
{% endblock %} 