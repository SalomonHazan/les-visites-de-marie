{% extends "base.html" %}

{% block title %}{{ visite.titre }} - Les Visites de Marie{% endblock %}

{% block content %}
    <div class="visite-detail">
        <div class="visite-header">
            <div class="visite-image-large">
                {% if visite.image_url %}
                    {% if visite.image_url.startswith('http') %}
                        <img src="{{ visite.image_url }}" alt="{{ visite.titre }}">
                    {% else %}
                        <img src="{{ url_for('static', filename=visite.image_url) }}" alt="{{ visite.titre }}">
                    {% endif %}
                {% else %}
                    <div class="no-image-large">üì∑</div>
                {% endif %}
            </div>
            <div class="visite-info">
                <h1>{{ visite.titre }}</h1>
                <p class="visite-description-full">{{ visite.description_complete }}</p>
                <div class="visite-stats">
                    <span class="stat">
                        <strong>{{ visite.etapes|length }}</strong> √©tapes
                    </span>
                    <span class="stat">
                        <strong>{{ visite.conseils|length }}</strong> conseils
                    </span>
                    <span class="stat">
                        Cr√©√©e le {{ visite.date_creation[:10] }}
                    </span>
                </div>
            </div>
        </div>

        <div class="visite-etapes">
            <h2>Itin√©raire de la visite</h2>
            {% for etape in visite.etapes %}
                <div class="etape">
                    <div class="etape-numero">
                        <span class="numero">{{ loop.index }}</span>
                    </div>
                    <div class="etape-header">
                        <h3>{{ etape.titre }}</h3>
                        <span class="duree">{{ etape.duree }}</span>
                    </div>
                    <p>{{ etape.description }}</p>
                    {% if etape.adresse %}
                        <div class="etape-adresse">
                            <div class="etape-info">
                                <strong>üìç Adresse :</strong> {{ etape.adresse }}
                            </div>
                            <div class="etape-actions">
                                <a href="https://maps.google.com/?q={{ etape.adresse|urlencode }}" 
                                   target="_blank" class="btn btn-small btn-green">
                                    Voir sur Google Maps
                                </a>
                            </div>
                        </div>
                    {% endif %}
                    {% if etape.metro %}
                        <div class="etape-metro">
                            <strong>üöá M√©tro :</strong> {{ etape.metro }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>

        {% if visite.conseils %}
            <div class="visite-conseils">
                <h2>Conseils pour cette visite</h2>
                <ul class="conseils-list">
                    {% for conseil in visite.conseils %}
                        <li>{{ conseil }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}



        {% if visite.etapes %}
            <div class="visite-parcours-map">
                <h2>üó∫Ô∏è Carte du parcours</h2>
                <div class="parcours-map">
                    <div id="map" style="width: 100%; height: 400px;"></div>
                </div>
            </div>
            
            <script>
                // M√©thode simple : utiliser OpenStreetMap (gratuit, sans cl√© API)
                function initMap() {
                    console.log('=== M√âTHODE SIMPLE : Carte OpenStreetMap ===');
                    
                    // R√©cup√©rer toutes les adresses des √©tapes
                    const adresses = [
                        {% for etape in visite.etapes %}
                            {% if etape.adresse %}
                                "{{ etape.adresse|replace('"', '\\"')|replace("'", "\\'") }}",
                            {% endif %}
                        {% endfor %}
                    ];
                    
                    console.log('Adresses trouv√©es:', adresses.length);
                    
                    if (adresses.length === 0) {
                        document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f8f9fa; color: #6c757d; font-style: italic;">Aucune adresse disponible pour afficher le parcours</div>';
                        return;
                    }
                    
                    // Cr√©er une carte OpenStreetMap avec Leaflet
                    const mapDiv = document.getElementById('map');
                    mapDiv.innerHTML = `
                        <div id="openstreetmap" style="width: 100%; height: 400px; border-radius: 10px;"></div>
                    `;
                    
                    // Charger Leaflet CSS et JS
                    const leafletCSS = document.createElement('link');
                    leafletCSS.rel = 'stylesheet';
                    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                    leafletCSS.integrity = 'sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=';
                    leafletCSS.crossOrigin = '';
                    document.head.appendChild(leafletCSS);
                    
                    const leafletJS = document.createElement('script');
                    leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    leafletJS.integrity = 'sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=';
                    leafletJS.crossOrigin = '';
                    
                    leafletJS.onload = function() {
                        // Initialiser la carte centr√©e sur Paris
                        const map = L.map('openstreetmap').setView([48.8566, 2.3522], 13);
                        
                        // Ajouter la couche OpenStreetMap
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(map);
                        
                        const markers = [];
                        const coordinates = [];
                        let processedCount = 0;
                        
                        // Fonction pour centrer la carte sur tous les marqueurs
                        function fitMapToMarkers() {
                            if (coordinates.length > 0) {
                                const bounds = L.latLngBounds(coordinates);
                                map.fitBounds(bounds, { padding: [20, 20] });
                                console.log('‚úÖ Carte centr√©e sur tous les marqueurs');
                            }
                        }
                        
                        // Fonction pour dessiner l'itin√©raire entre deux points
                        function drawRoute(fromCoord, toCoord, index) {
                            // Utiliser l'API OSRM pour calculer l'itin√©raire √† pied
                            const url = `https://router.project-osrm.org/route/v1/foot/${fromCoord.lng},${fromCoord.lat};${toCoord.lng},${toCoord.lat}?overview=full&geometries=geojson`;
                            
                            fetch(url)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.routes && data.routes.length > 0) {
                                        const route = data.routes[0];
                                        const routeGeometry = route.geometry;
                                        
                                        // Dessiner la ligne rose fuchsia fonc√© pour l'itin√©raire
                                        const routeLine = L.geoJSON(routeGeometry, {
                                            style: {
                                                color: '#8B008B', // Rose fuchsia fonc√©
                                                weight: 4,
                                                opacity: 0.8
                                            }
                                        }).addTo(map);
                                        
                                        console.log(`‚úÖ Itin√©raire ${index} dessin√© (${Math.round(route.distance)}m, ${Math.round(route.duration / 60)}min)`);
                                    }
                                })
                                .catch(error => {
                                    console.log(`Erreur calcul itin√©raire ${index}:`, error);
                                    // Fallback : ligne droite si l'API √©choue
                                    const straightLine = L.polyline([fromCoord, toCoord], {
                                        color: '#8B008B', // Rose fuchsia fonc√©
                                        weight: 3,
                                        opacity: 0.6,
                                        dashArray: '5, 5'
                                    }).addTo(map);
                                });
                        }
                        
                        // Ajouter des marqueurs pour chaque adresse
                        adresses.forEach((adresse, index) => {
                            // G√©ocoder l'adresse avec Nominatim (gratuit)
                            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(adresse + ', Paris, France')}&limit=1`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.length > 0) {
                                        const lat = parseFloat(data[0].lat);
                                        const lon = parseFloat(data[0].lon);
                                        const coord = L.latLng(lat, lon);
                                        
                                        // Cr√©er le marqueur avec num√©ro
                                        const marker = L.marker(coord, {
                                            icon: L.divIcon({
                                                className: 'custom-marker',
                                                html: `<div style="background: #8e44ad; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">${index + 1}</div>`,
                                                iconSize: [30, 30],
                                                iconAnchor: [15, 15]
                                            })
                                        }).addTo(map);
                                        
                                        // Popup avec informations
                                        const popupContent = `
                                            <div style="padding: 10px; max-width: 200px;">
                                                <h4 style="margin: 0 0 5px 0; color: #8e44ad;">√âtape ${index + 1}</h4>
                                                <p style="margin: 0; font-size: 12px; color: #666;">${adresse}</p>
                                                <a href="https://maps.google.com/?q=${encodeURIComponent(adresse)}" 
                                                   target="_blank" 
                                                   style="color: #8e44ad; text-decoration: none; font-size: 11px;">
                                                    üìç Voir sur Google Maps
                                                </a>
                                            </div>
                                        `;
                                        
                                        marker.bindPopup(popupContent);
                                        markers.push(marker);
                                        coordinates.push(coord);
                                    }
                                    
                                    processedCount++;
                                    
                                    // Si tous les marqueurs sont trait√©s, centrer la carte et dessiner tous les itin√©raires
                                    if (processedCount === adresses.length) {
                                        setTimeout(() => {
                                            fitMapToMarkers();
                                            
                                            // Dessiner tous les itin√©raires s√©quentiellement
                                            for (let i = 0; i < coordinates.length - 1; i++) {
                                                const fromCoord = coordinates[i];
                                                const toCoord = coordinates[i + 1];
                                                drawRoute(fromCoord, toCoord, i + 1);
                                            }
                                        }, 1000);
                                    }
                                })
                                .catch(error => {
                                    console.log('Erreur g√©ocodage pour:', adresse, error);
                                    processedCount++;
                                    
                                    if (processedCount === adresses.length) {
                                        setTimeout(fitMapToMarkers, 1000);
                                    }
                                });
                        });
                        
                        console.log('‚úÖ Carte OpenStreetMap cr√©√©e avec succ√®s !');
                    };
                    
                    document.head.appendChild(leafletJS);
                    
                    // Ajouter une liste des √©tapes sous la carte
                    const etapesList = document.createElement('div');
                    etapesList.style.marginTop = '20px';
                    etapesList.style.padding = '15px';
                    etapesList.style.background = 'rgba(142, 68, 173, 0.05)';
                    etapesList.style.borderRadius = '8px';
                    etapesList.style.borderLeft = '3px solid #8e44ad';
                    
                    etapesList.innerHTML = `
                        <h3 style="margin: 0 0 15px 0; color: #8e44ad;">üìç √âtapes du parcours</h3>
                        <div style="display: grid; gap: 10px;">
                            {% for etape in visite.etapes %}
                                {% if etape.adresse %}
                                    <div style="display: flex; align-items: center; gap: 10px; padding: 8px; background: white; border-radius: 5px;">
                                        <span style="background: #8e44ad; color: white; width: 25px; height: 25px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px;">{{ loop.index }}</span>
                                        <div style="flex: 1;">
                                            <strong style="color: #8e44ad;">{{ etape.titre }}</strong><br>
                                            <small style="color: #666;">{{ etape.adresse }}</small>
                                        </div>
                                        <a href="https://maps.google.com/?q={{ etape.adresse|urlencode }}" target="_blank" style="color: #8e44ad; text-decoration: none; font-size: 12px;">üìç</a>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    `;
                    
                    mapDiv.appendChild(etapesList);
                }
            </script>
            
                            <script>
                    // Charger la carte quand la page est pr√™te
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initMap);
                    } else {
                        initMap();
                    }
                </script>
        {% endif %}

        <div class="visite-actions">
            <a href="{{ url_for('menu_page', menu_id='ballades') }}" class="btn btn-secondary">‚Üê Retour aux visites</a>
        </div>
    </div>
{% endblock %} 